<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>探究学習レポート</title>
    
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f4f7f9; color: #333; padding: 20px; line-height: 1.6; }
      .app-container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
      h1, h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
      h1 { font-size: 28px; }
      h2 { font-size: 22px; }
      .form-group, .inquiry-cycle { margin-bottom: 25px; }
      label { display: block; font-weight: bold; margin-bottom: 8px; color: #34495e; }
      input[type="text"], textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
      textarea { min-height: 100px; resize: vertical; }
      .button-container { margin-top: 30px; display: flex; gap: 15px; flex-wrap: wrap; }
      button { background-color: #3498db; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
      button:hover { background-color: #2980b9; }
      button.secondary { background-color: #2ecc71; }
      button.secondary:hover { background-color: #27ae60; }
      button.tertiary { background-color: #95a5a6; }
      button.tertiary:hover { background-color: #7f8c8d; }

      .report-view { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); font-family: 'Hiragino Mincho ProN', 'MS PMincho', serif; }
      .report-view h1 { text-align: center; border-bottom: none; font-size: 32px; }
      .report-view h2 { font-size: 24px; color: #34495e; border-bottom: 2px solid #3498db; margin-top: 40px; }
      .report-view h3 { font-size: 20px; color: #2c3e50; border-left: 4px solid #3498db; padding-left: 10px; margin-top: 30px; }
      .report-view h4 { font-size: 16px; color: #34495e; margin-top: 20px; margin-bottom: 5px; }
      .report-view p { white-space: pre-wrap; background: #fdfdfd; padding: 10px; border-radius: 4px; border: 1px solid #ecf0f1; margin-left: 15px; }
      .report-view .student-info { text-align: right; font-size: 16px; border: none; background: none; padding: 0; }
      .report-view .conclusion p { background: #eaf5fc; }
      
      .report-view .button-container { 
        justify-content: flex-end; 
        margin-bottom: 20px; 
        padding-bottom: 20px; 
        border-bottom: 1px solid #eee;
      }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script type="text/babel" data-type="module">
      const { useState, useRef } = React;
      
      const ReportView = ({ data, onClose, onExportPdf }) => {
        return (
          <div className="report-view">
            {/* idをreport-contentからpdf-targetに変更 */}
            <div id="pdf-target">
              <div className="button-container">
                <button className="tertiary" onClick={onClose} data-html2canvas-ignore="true">フォームに戻る</button>
                <button className="secondary" onClick={onExportPdf} data-html2canvas-ignore="true">PDF形式で書き出す</button>
              </div>

              <h1 className="report-title">探究学習レポート</h1>
              <p className="student-info">{data.grade || '＿'}年 {data.class || '＿'}組 {data.name || '＿＿＿＿'}</p>
              <h2 className="report-theme">テーマ: 2025年ノーベル物理学賞 「電気回路における巨視的量子力学的トンネル効果とエネルギー量子化の発見」</h2>
              
              {data.inquiries.map((inquiry, index) => (
                <div className="report-section" key={`report-${index}`}>
                  <h3>◆ 問いのサイクル {index + 1}</h3>
                  <div><h4>1. 問い</h4><p>{inquiry.question || '(未入力)'}</p></div>
                  <div><h4>2. 問いに対する自分の考え、予想、仮説</h4><p>{inquiry.hypothesis || '(未入力)'}</p></div>
                  <div><h4>3. 問いについて調べたこと</h4><p>{inquiry.research || '(未入力)'}</p></div>
                  <div><h4>4. 「自分の考え・予想・仮説」と「調べたこと」を比較して、気づいたこと</h4><p>{inquiry.findings || '(未入力)'}</p></div>
                </div>
              ))}

              <div className="report-section conclusion">
                <h2>◆ ３つの気づきから、分かったこと</h2>
                <p>{data.conclusion || '(未入力)'}</p>
              </div>
            </div>
          </div>
        );
      };

      const App = () => {
        const createInitialInquiries = () => Array.from({ length: 3 }, () => ({ question: '', hypothesis: '', research: '', findings: '' }));
        const [formData, setFormData] = useState({ grade: '', class: '', name: '', inquiries: createInitialInquiries(), conclusion: '' });
        const [isReportVisible, setIsReportVisible] = useState(false);
        const fileInputRef = useRef(null);
        
        const getFormattedDate = () => { const date = new Date(); const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; };
        const handleInputChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); };
        const handleInquiryChange = (index, e) => { const { name, value } = e.target; const newInquiries = formData.inquiries.map((inquiry, i) => i === index ? { ...inquiry, [name]: value } : inquiry); setFormData(prev => ({ ...prev, inquiries: newInquiries })); };
        const saveToJson = () => {
          const dataToSave = { ...formData, savedAt: new Date().toISOString() }; const jsonString = JSON.stringify(dataToSave, null, 2); const blob = new Blob([jsonString], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); const filename = `${formData.name || 'report'}_${getFormattedDate()}.json`; a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); alert(`「${filename}」として保存しました！`);
        };
        const handleFileLoad = (e) => {
          const file = e.target.files?.[0]; if (!file) return;
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const text = event.target?.result;
              if (typeof text === 'string') {
                const loaded = JSON.parse(text);
                const newInquiries = createInitialInquiries().map((inquiry, i) => ({ ...inquiry, ...(loaded.inquiries?.[i] || {}) }));
                setFormData({ grade: loaded.grade || '', class: loaded.class || '', name: loaded.name || '', inquiries: newInquiries, conclusion: loaded.conclusion || '' });
                setIsReportVisible(true);
                alert('データを読み込み、レポート形式で表示しました！');
              }
            } catch (error) { console.error("JSONの読み込みに失敗しました:", error); alert('ファイルの形式が正しくないようです。'); } 
            finally { e.target.value = ''; }
          };
          reader.readAsText(file);
        };
        const loadFromJson = () => { fileInputRef.current?.click(); };
        
        // ★★ 修正: PDF書き出しロジックをお手本ファイルと同様の方式に変更 ★★
        const exportToPdf = async () => {
          alert('PDFの生成を開始します...');
          const { jsPDF } = window.jspdf;
          const target = document.getElementById('pdf-target');
          if (!target) {
            alert("PDF生成対象の要素が見つかりません。");
            return;
          }

          try {
            const canvas = await html2canvas(target, {
                scale: 2, // 高解像度でキャプチャ
                useCORS: true,
                // `data-html2canvas-ignore` 属性を持つ要素を無視する
                ignoreElements: (element) => element.hasAttribute('data-html2canvas-ignore')
            });

            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF({
              orientation: 'p',
              unit: 'mm',
              format: 'a4'
            });

            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

            let heightLeft = pdfHeight;
            let position = 0;

            pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight, undefined, 'FAST');
            heightLeft -= pdf.internal.pageSize.getHeight();

            while (heightLeft > 0) {
              position = heightLeft - pdfHeight;
              pdf.addPage();
              pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight, undefined, 'FAST');
              heightLeft -= pdf.internal.pageSize.getHeight();
            }
            
            const filename = `${formData.name || 'report'}_${getFormattedDate()}.pdf`;
            pdf.save(filename);
          } catch (error) {
            console.error("PDF生成中にエラーが発生しました:", error);
            alert("PDFの生成に失敗しました。");
          }
        };
        
        if (isReportVisible) {
          return <ReportView 
                    data={formData} 
                    onClose={() => setIsReportVisible(false)}
                    onExportPdf={exportToPdf}
                 />;
        }

        return (
          <div className="app-container">
            <h1>探究学習レポート</h1>
            <h2>2025年ノーベル物理学賞 ...</h2>
            <div className="form-group"><label htmlFor="grade">学年:</label><input type="text" id="grade" name="grade" value={formData.grade} onChange={handleInputChange} /></div>
            <div className="form-group"><label htmlFor="class">クラス:</label><input type="text" id="class" name="class" value={formData.class} onChange={handleInputChange} /></div>
            <div className="form-group"><label htmlFor="name">名前:</label><input type="text" id="name" name="name" value={formData.name} onChange={handleInputChange} /></div>
            {formData.inquiries.map((_, index) => (
              <div key={index} className="inquiry-cycle">
                <h2>問いのサイクル {index + 1}</h2>
                <div className="form-group"><label>1. 問い</label><textarea name="question" value={formData.inquiries[index].question} onChange={(e) => handleInquiryChange(index, e)} /></div>
                <div className="form-group"><label>2. ...自分の考え、予想、仮説</label><textarea name="hypothesis" value={formData.inquiries[index].hypothesis} onChange={(e) => handleInquiryChange(index, e)} /></div>
                <div className="form-group"><label>3. ...調べたこと</label><textarea name="research" value={formData.inquiries[index].research} onChange={(e) => handleInquiryChange(index, e)} /></div>
                <div className="form-group"><label>4. ...気づいたこと</label><textarea name="findings" value={formData.inquiries[index].findings} onChange={(e) => handleInquiryChange(index, e)} /></div>
              </div>
            ))}
            <div className="form-group"><h2>最後の項目</h2><label>３つの気づきから、分かったこと</label><textarea name="conclusion" value={formData.conclusion} onChange={handleInputChange} /></div>
            <div className="button-container">
              <button onClick={saveToJson}>JSON形式で保存</button>
              <button className="tertiary" onClick={loadFromJson}>JSONファイルを読み込む</button>
              <input type="file" accept=".json" ref={fileInputRef} onChange={handleFileLoad} style={{ display: 'none' }} />
            </div>
          </div>
        );
      };

      const container = document.getElementById('root');
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    </script>
</body>
</html>
